id: B16
name: "CV Manager Page (Full Integration)"
phase: 1
phase_name: "CV Management"

goal: |
  Create the complete CV Manager page that integrates all CV components.
  Users can upload/enter their CV, see AI-extracted fields, complete missing info,
  preview their CV, and save to database.

dependencies: [B01, B02, B03, B04, B05, B06, B07, B08, B09, B10, B11, B12, B13, B14, B15]

files_to_create:
  - id: F013
    path: "src/app/[locale]/cv-manager/page.tsx"
    description: "Main CV Manager page"

  - id: F103
    path: "src/app/[locale]/cv-manager/loading.tsx"
    description: "Loading state for CV Manager"

  - id: F117
    path: "src/components/cv/CVManagerTabs.tsx"
    description: "Tab navigation for CV Manager workflow"

files_to_modify:
  - id: F087
    path: "src/i18n/en.json"
    description: "Add CV Manager page translations"

  - id: F088
    path: "src/i18n/fa.json"
    description: "Add CV Manager page translations"

files_available:
  - id: F027
    path: "src/components/ui/button.tsx"
    from_block: B02
  - id: F029
    path: "src/components/ui/card.tsx"
    from_block: B02
  - id: F033
    path: "src/components/ui/tabs.tsx"
    from_block: B02
  - id: F035
    path: "src/components/ui/toast.tsx"
    from_block: B02
  - id: F079
    path: "src/lib/types.ts"
    from_block: B03
  - id: F092
    path: "src/components/auth/AuthGuard.tsx"
    from_block: B07
  - id: F041
    path: "src/components/cv/CVUploader.tsx"
    from_block: B13
  - id: F042
    path: "src/components/cv/CVFieldDisplay.tsx"
    from_block: B14
  - id: F043
    path: "src/components/cv/CVCompletionForm.tsx"
    from_block: B14
  - id: F044
    path: "src/components/cv/CVPreview.tsx"
    from_block: B14
  - id: F082
    path: "src/hooks/useCV.ts"
    from_block: B15

commands: []

instructions: |
  1. Create CVManagerTabs.tsx:
     ```typescript
     // ============================================
     // [F117] src/components/cv/CVManagerTabs.tsx
     // ============================================
     
     'use client';
     
     import { useTranslations } from 'next-intl';
     import { Tabs, TabsList, TabsTrigger } from '@/components/ui/tabs';
     import { Upload, ListChecks, Eye } from 'lucide-react';
     import { cn } from '@/lib/utils';
     
     type CVTab = 'upload' | 'fields' | 'preview';
     
     interface CVManagerTabsProps {
       activeTab: CVTab;
       onTabChange: (tab: CVTab) => void;
       hasCV: boolean;
       completionPercentage: number;
       disabled?: boolean;
       className?: string;
     }
     
     export function CVManagerTabs({
       activeTab,
       onTabChange,
       hasCV,
       completionPercentage,
       disabled = false,
       className
     }: CVManagerTabsProps) {
       const t = useTranslations('cv_manager');
       
       return (
         <Tabs 
           value={activeTab} 
           onValueChange={(v) => onTabChange(v as CVTab)}
           className={className}
         >
           <TabsList className="grid w-full grid-cols-3">
             <TabsTrigger 
               value="upload" 
               disabled={disabled}
               className="flex items-center gap-2"
             >
               <Upload className="h-4 w-4" />
               <span className="hidden sm:inline">{t('upload_tab')}</span>
             </TabsTrigger>
             
             <TabsTrigger 
               value="fields" 
               disabled={disabled || !hasCV}
               className="flex items-center gap-2"
             >
               <ListChecks className="h-4 w-4" />
               <span className="hidden sm:inline">{t('fields_tab')}</span>
               {hasCV && completionPercentage < 100 && (
                 <span className={cn(
                   'text-xs px-1.5 py-0.5 rounded-full',
                   completionPercentage >= 70 
                     ? 'bg-green-100 text-green-700' 
                     : 'bg-yellow-100 text-yellow-700'
                 )}>
                   {completionPercentage}%
                 </span>
               )}
             </TabsTrigger>
             
             <TabsTrigger 
               value="preview" 
               disabled={disabled || !hasCV}
               className="flex items-center gap-2"
             >
               <Eye className="h-4 w-4" />
               <span className="hidden sm:inline">{t('preview_tab')}</span>
             </TabsTrigger>
           </TabsList>
         </Tabs>
       );
     }
     ```
  
  2. Create cv-manager/loading.tsx:
     ```typescript
     // ============================================
     // [F103] src/app/[locale]/cv-manager/loading.tsx
     // ============================================
     
     import { Skeleton } from '@/components/ui/skeleton';
     import { Card, CardContent, CardHeader } from '@/components/ui/card';
     
     export default function Loading() {
       return (
         <div className="container mx-auto p-6 space-y-6">
           {/* Header skeleton */}
           <div className="space-y-2">
             <Skeleton className="h-8 w-64" />
             <Skeleton className="h-4 w-96" />
           </div>
           
           {/* Tabs skeleton */}
           <Skeleton className="h-10 w-full" />
           
           {/* Content skeleton */}
           <Card>
             <CardHeader>
               <Skeleton className="h-6 w-48" />
             </CardHeader>
             <CardContent className="space-y-4">
               <Skeleton className="h-32 w-full" />
               <Skeleton className="h-10 w-32" />
             </CardContent>
           </Card>
         </div>
       );
     }
     ```
  
  3. Create cv-manager/page.tsx:
     ```typescript
     // ============================================
     // [F013] src/app/[locale]/cv-manager/page.tsx
     // ============================================
     
     'use client';
     
     import { useState, useEffect } from 'react';
     import { useTranslations } from 'next-intl';
     import { useParams } from 'next/navigation';
     import { AuthGuard } from '@/components/auth/AuthGuard';
     import { CVUploader } from '@/components/cv/CVUploader';
     import { CVFieldDisplay } from '@/components/cv/CVFieldDisplay';
     import { CVCompletionForm } from '@/components/cv/CVCompletionForm';
     import { CVPreview } from '@/components/cv/CVPreview';
     import { CVManagerTabs } from '@/components/cv/CVManagerTabs';
     import { useCV } from '@/hooks/useCV';
     import { Button } from '@/components/ui/button';
     import { Card, CardContent } from '@/components/ui/card';
     import { useToast } from '@/components/ui/use-toast';
     import { CVExtractionResult, ComprehensiveCV } from '@/lib/types';
     import { 
       FileText, Save, Trash2, CheckCircle, AlertCircle, Loader2 
     } from 'lucide-react';
     import { cn } from '@/lib/utils';
     
     type CVTab = 'upload' | 'fields' | 'preview';
     
     export default function CVManagerPage() {
       const t = useTranslations('cv_manager');
       const params = useParams();
       const locale = params.locale as 'en' | 'fa';
       const { toast } = useToast();
       
       const {
         cv,
         loading,
         saving,
         error,
         fieldStatuses,
         completionPercentage,
         saveCV,
         updateCV,
         deleteCV,
         applyExtraction
       } = useCV();
       
       const [activeTab, setActiveTab] = useState<CVTab>('upload');
       const [pendingExtraction, setPendingExtraction] = useState<CVExtractionResult | null>(null);
       
       // Switch to fields tab when CV is loaded or extracted
       useEffect(() => {
         if (cv && activeTab === 'upload') {
           setActiveTab('fields');
         }
       }, [cv]);
       
       // Handle extraction complete
       const handleExtractionComplete = async (result: CVExtractionResult) => {
         setPendingExtraction(result);
         
         try {
           await applyExtraction(result);
           
           toast({
             title: t('extraction_success'),
             description: t('extraction_success_desc'),
           });
           
           setActiveTab('fields');
           
         } catch (err: any) {
           toast({
             variant: 'destructive',
             title: t('extraction_error'),
             description: err.message,
           });
         } finally {
           setPendingExtraction(null);
         }
       };
       
       // Handle CV update from field display
       const handleCVUpdate = async (updates: Partial<ComprehensiveCV>) => {
         try {
           await updateCV(updates);
           
           toast({
             title: t('saved'),
             description: t('changes_saved'),
           });
           
         } catch (err: any) {
           toast({
             variant: 'destructive',
             title: t('save_error'),
             description: err.message,
           });
         }
       };
       
       // Handle delete CV
       const handleDeleteCV = async () => {
         if (!confirm(t('delete_confirm'))) return;
         
         try {
           await deleteCV();
           setActiveTab('upload');
           
           toast({
             title: t('deleted'),
             description: t('cv_deleted'),
           });
           
         } catch (err: any) {
           toast({
             variant: 'destructive',
             title: t('delete_error'),
             description: err.message,
           });
         }
       };
       
       // Get incomplete fields
       const incompleteFields = fieldStatuses.filter(s => !s.is_complete);
       
       return (
         <AuthGuard>
           <div className="container mx-auto p-6 max-w-5xl">
             {/* Header */}
             <div className="mb-6">
               <h1 className="text-2xl font-bold flex items-center gap-2">
                 <FileText className="h-6 w-6" />
                 {t('title')}
               </h1>
               <p className="text-muted-foreground mt-1">
                 {t('description')}
               </p>
             </div>
             
             {/* Error Display */}
             {error && (
               <Card className="mb-6 border-destructive">
                 <CardContent className="py-4">
                   <div className="flex items-center gap-2 text-destructive">
                     <AlertCircle className="h-5 w-5" />
                     <span>{error}</span>
                   </div>
                 </CardContent>
               </Card>
             )}
             
             {/* Loading State */}
             {loading ? (
               <Card>
                 <CardContent className="py-12">
                   <div className="flex flex-col items-center justify-center gap-3">
                     <Loader2 className="h-8 w-8 animate-spin text-muted-foreground" />
                     <p className="text-muted-foreground">{t('loading')}</p>
                   </div>
                 </CardContent>
               </Card>
             ) : (
               <>
                 {/* Tab Navigation */}
                 <CVManagerTabs
                   activeTab={activeTab}
                   onTabChange={setActiveTab}
                   hasCV={cv !== null}
                   completionPercentage={completionPercentage}
                   disabled={saving}
                   className="mb-6"
                 />
                 
                 {/* Tab Content */}
                 <div className="space-y-6">
                   
                   {/* Upload Tab */}
                   {activeTab === 'upload' && (
                     <CVUploader
                       onExtractionComplete={handleExtractionComplete}
                       existingCV={cv}
                       disabled={saving}
                     />
                   )}
                   
                   {/* Fields Tab */}
                   {activeTab === 'fields' && cv && (
                     <>
                       {/* Incomplete Fields Warning */}
                       {incompleteFields.length > 0 && (
                         <CVCompletionForm
                           incompleteFields={incompleteFields}
                           onFieldClick={(section) => {
                             // Scroll to section or open edit modal
                             console.log('Navigate to section:', section);
                           }}
                         />
                       )}
                       
                       {/* Field Display */}
                       <CVFieldDisplay
                         cv={cv}
                         fieldStatuses={fieldStatuses}
                         confidence={pendingExtraction?.confidence || 85}
                         onUpdate={handleCVUpdate}
                       />
                     </>
                   )}
                   
                   {/* Preview Tab */}
                   {activeTab === 'preview' && cv && (
                     <CVPreview
                       cv={cv}
                       locale={locale}
                     />
                   )}
                   
                 </div>
                 
                 {/* Action Bar */}
                 {cv && (
                   <div className="mt-8 flex items-center justify-between border-t pt-6">
                     <div className="flex items-center gap-2 text-sm text-muted-foreground">
                       <CheckCircle className={cn(
                         'h-4 w-4',
                         completionPercentage === 100 ? 'text-green-500' : 'text-yellow-500'
                       )} />
                       <span>
                         {t('completion', { percent: completionPercentage })}
                       </span>
                     </div>
                     
                     <div className="flex items-center gap-3">
                       <Button
                         variant="outline"
                         onClick={handleDeleteCV}
                         disabled={saving}
                       >
                         <Trash2 className="h-4 w-4 mr-2" />
                         {t('delete_cv')}
                       </Button>
                       
                       <Button
                         onClick={() => saveCV(cv)}
                         disabled={saving}
                       >
                         {saving ? (
                           <>
                             <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                             {t('saving')}
                           </>
                         ) : (
                           <>
                             <Save className="h-4 w-4 mr-2" />
                             {t('save_cv')}
                           </>
                         )}
                       </Button>
                     </div>
                   </div>
                 )}
               </>
             )}
           </div>
         </AuthGuard>
       );
     }
     ```
  
  4. Add translations to en.json under "cv_manager" key:
     ```json
     {
       "cv_manager": {
         "title": "My Comprehensive CV",
         "description": "Upload, edit, and manage your comprehensive CV",
         "upload_tab": "Upload",
         "fields_tab": "Edit Fields",
         "preview_tab": "Preview",
         "loading": "Loading your CV...",
         "extraction_success": "CV Extracted Successfully",
         "extraction_success_desc": "Your CV has been processed. Please review the extracted information.",
         "extraction_error": "Extraction Failed",
         "saved": "Saved",
         "changes_saved": "Your changes have been saved.",
         "save_error": "Save Failed",
         "delete_confirm": "Are you sure you want to delete your CV? This action cannot be undone.",
         "deleted": "Deleted",
         "cv_deleted": "Your CV has been deleted.",
         "delete_error": "Delete Failed",
         "completion": "{percent}% complete",
         "save_cv": "Save CV",
         "saving": "Saving...",
         "delete_cv": "Delete CV"
       }
     }
     ```
  
  5. Add same translations to fa.json:
     ```json
     {
       "cv_manager": {
         "title": "سی‌وی جامع من",
         "description": "آپلود، ویرایش و مدیریت سی‌وی جامع شما",
         "upload_tab": "آپلود",
         "fields_tab": "ویرایش فیلدها",
         "preview_tab": "پیش‌نمایش",
         "loading": "در حال بارگذاری سی‌وی...",
         "extraction_success": "سی‌وی با موفقیت استخراج شد",
         "extraction_success_desc": "سی‌وی شما پردازش شد. لطفاً اطلاعات استخراج‌شده را بررسی کنید.",
         "extraction_error": "استخراج ناموفق بود",
         "saved": "ذخیره شد",
         "changes_saved": "تغییرات شما ذخیره شد.",
         "save_error": "ذخیره ناموفق بود",
         "delete_confirm": "آیا مطمئن هستید که می‌خواهید سی‌وی خود را حذف کنید؟ این عمل قابل بازگشت نیست.",
         "deleted": "حذف شد",
         "cv_deleted": "سی‌وی شما حذف شد.",
         "delete_error": "حذف ناموفق بود",
         "completion": "{percent}% تکمیل",
         "save_cv": "ذخیره سی‌وی",
         "saving": "در حال ذخیره...",
         "delete_cv": "حذف سی‌وی"
       }
     }
     ```

checkpoint_tests:
  - id: T01
    description: "CV Manager page files exist"
    type: "files_exist"
    files:
      - "src/app/[locale]/cv-manager/page.tsx"
      - "src/app/[locale]/cv-manager/loading.tsx"
      - "src/components/cv/CVManagerTabs.tsx"

  - id: T02
    description: "TypeScript compiles without errors"
    type: "command"
    command: "npx tsc --noEmit"
    expected_exit_code: 0

  - id: T03
    description: "CV Manager page uses AuthGuard"
    type: "grep"
    file: "src/app/[locale]/cv-manager/page.tsx"
    patterns:
      - "AuthGuard"
      - "<AuthGuard>"

  - id: T04
    description: "CV Manager page uses all CV components"
    type: "grep"
    file: "src/app/[locale]/cv-manager/page.tsx"
    patterns:
      - "CVUploader"
      - "CVFieldDisplay"
      - "CVCompletionForm"
      - "CVPreview"
      - "CVManagerTabs"

  - id: T05
    description: "CV Manager page uses useCV hook"
    type: "grep"
    file: "src/app/[locale]/cv-manager/page.tsx"
    patterns:
      - "useCV"
      - "saveCV"
      - "updateCV"
      - "applyExtraction"

  - id: T06
    description: "CV Manager has tab navigation"
    type: "grep"
    file: "src/app/[locale]/cv-manager/page.tsx"
    patterns:
      - "activeTab"
      - "setActiveTab"
      - "upload"
      - "fields"
      - "preview"

  - id: T07
    description: "Uses toast notifications"
    type: "grep"
    file: "src/app/[locale]/cv-manager/page.tsx"
    patterns:
      - "useToast"
      - "toast({"

  - id: T08
    description: "CV Manager uses i18n"
    type: "grep"
    file: "src/app/[locale]/cv-manager/page.tsx"
    patterns:
      - "useTranslations"
      - "cv_manager"

  - id: T09
    description: "English translations have CV Manager keys"
    type: "grep"
    file: "src/i18n/en.json"
    patterns:
      - "cv_manager"
      - "upload_tab"
      - "fields_tab"
      - "preview_tab"
      - "extraction_success"

  - id: T10
    description: "Farsi translations have CV Manager keys"
    type: "grep"
    file: "src/i18n/fa.json"
    patterns:
      - "cv_manager"
      - "extraction_success"

  - id: T11
    description: "Loading component exists with skeleton"
    type: "grep"
    file: "src/app/[locale]/cv-manager/loading.tsx"
    patterns:
      - "export default function Loading"
      - "Skeleton"

max_retries: 3